<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudoku Puzzle</title>
    <style>
        body {
            background-color: #f6f8fa;
            color: #1c1c1c;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 600px;
            width: 100%;
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #005fa3;
            margin-bottom: 20px;
        }

        .message-area {
            min-height: 30px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #346f99;
        }

        #sudoku-board {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            border: 3px solid #005fa3;
            width: 100%;
            aspect-ratio: 1 / 1;
            box-sizing: border-box;
        }

        .sudoku-cell {
            border: 1px solid #d3d6da;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #1c1c1c;
            background-color: #e8f4ff;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .sudoku-cell.fixed {
            background-color: #d8e6f1;
            color: #005fa3;
        }

        .sudoku-cell.error {
            background-color: #ffcccc;
            color: #cc0000;
        }

        .sudoku-cell:hover {
            background-color: #c0c3c6;
        }

        .sudoku-cell.active {
            background-color: #a3e6ff;
        }

        .sudoku-section-border-right {
            border-right: 3px solid #005fa3;
        }

        .sudoku-section-border-bottom {
            border-bottom: 3px solid #005fa3;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }

        .controls button {
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            transition: background-color 0.3s ease;
        }

        .controls button:hover {
            background-color: #0056b3;
        }

        .game-instructions {
            margin-top: 30px;
            padding: 20px;
            background-color: #e8f4ff;
            border: 1px solid #a3e6ff;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            width: 100%;
        }
        
        .game-instructions h2 {
            color: #005fa3;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .game-instructions p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">Sudoku Puzzle</h1>
        <div class="message-area" id="message-area"></div>
        <div id="sudoku-board">
            <!-- Grid will be dynamically generated here -->
        </div>
        <div class="controls">
            <button id="check-button">Check Solution</button>
            <button id="new-game-button">New Game</button>
            <button id="hint-button">Hint (<span id="hints-left">3</span>)</button>
        </div>
        <div class="game-instructions">
            <h2>Sudoku: How to Play</h2>
            <p>Welcome to **Sudoku**, a classic puzzle game that will sharpen your mind and reward you for your effort! The goal is to fill the entire 9x9 grid with digits so that every column, every row, and every of the nine 3x3 subgrids contains all of the digits from 1 to 9 exactly once.</p>
            
            <h3>How to Play</h3>
            <p><strong>1. Fill the Grid:</strong> Click on an empty cell and enter a digit from 1 to 9. The game will provide a new, solvable puzzle each time you start.</p>
            <p><strong>2. Follow the Rules:</strong> Remember, a number cannot be repeated in the same row, column, or 3x3 box. Be careful with your choices!</p>
            <p><strong>3. Check Your Progress:</strong> Click the "Check Solution" button to see if your current solution is correct. The game will highlight any errors to help you fix them.</p>
            <p><strong>4. Use a Hint:</strong> If you get stuck, click the "Hint" button for help! You have 3 hints per puzzle. The hint button will be disabled when you run out of hints.</p>
            
            <h3>Earning Points</h3>
            <p>When you successfully complete the puzzle, you will be awarded **300 points** to your account! These points will be added to your total and can be viewed on your dashboard. Using a hint does not affect the points you earn for solving the puzzle.</p>
        </div>
    </div>

    <script type="module">
        import { getAuth, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, doc, setDoc, increment } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";

        // Use canvas variables if they exist, otherwise use fallbacks
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firebase configuration from your dashboard
        const firebaseConfig = {
            apiKey: "AIzaSyA0tfVT75kWle3uwz1HouHRQdEWyzW1YNU",
            authDomain: "chat-code-forum.firebaseapp.com",
            projectId: "chat-code-forum",
            storageBucket: "chat-code-forum.appspot.com",
            messagingSenderId: "496765673859",
            appId: "1:496765673859:web:6c2e6695be447d6e32d6b6",
            measurementId: "G-XJKWXHF8WN"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let userId = null;
        let isAuthReady = false;
        let hintsLeft = 3;

        // --- Game Setup ---
        const board = document.getElementById('sudoku-board');
        const messageArea = document.getElementById('message-area');
        const checkButton = document.getElementById('check-button');
        const newGameButton = document.getElementById('new-game-button');
        const hintButton = document.getElementById('hint-button');
        const hintsLeftSpan = document.getElementById('hints-left');
        let activeCell = null;
        let puzzle = [];
        let solution = [];
        const PUZZLE_SIZE = 9;

        // A simple solvable Sudoku puzzle
        const solvedBoard = [
            [5, 3, 4, 6, 7, 8, 9, 1, 2],
            [6, 7, 2, 1, 9, 5, 3, 4, 8],
            [1, 9, 8, 3, 4, 2, 5, 6, 7],
            [8, 5, 9, 7, 6, 1, 4, 2, 3],
            [4, 2, 6, 8, 5, 3, 7, 9, 1],
            [7, 1, 3, 9, 2, 4, 8, 5, 6],
            [9, 6, 1, 5, 3, 7, 2, 8, 4],
            [2, 8, 7, 4, 1, 9, 6, 3, 5],
            [3, 4, 5, 2, 8, 6, 1, 7, 9]
        ];

        // --- Game Logic ---
        function createPuzzle() {
            // Start with the solved board and create the puzzle by removing some numbers
            puzzle = solvedBoard.map(row => [...row]);
            solution = solvedBoard.map(row => [...row]);

            // Hide some numbers to create the puzzle
            const cellsToRemove = 45; // A good number for a medium difficulty puzzle
            let count = 0;
            while (count < cellsToRemove) {
                const row = Math.floor(Math.random() * 9);
                const col = Math.floor(Math.random() * 9);
                if (puzzle[row][col] !== 0) {
                    puzzle[row][col] = 0;
                    count++;
                }
            }
        }

        function renderBoard() {
            board.innerHTML = '';
            for (let r = 0; r < PUZZLE_SIZE; r++) {
                for (let c = 0; c < PUZZLE_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('sudoku-cell');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    
                    const cellValue = puzzle[r][c];
                    if (cellValue !== 0) {
                        cell.textContent = cellValue;
                        cell.classList.add('fixed');
                    }
                    
                    // Add borders for 3x3 sections
                    if ((c + 1) % 3 === 0 && c !== 8) {
                        cell.classList.add('sudoku-section-border-right');
                    }
                    if ((r + 1) % 3 === 0 && r !== 8) {
                        cell.classList.add('sudoku-section-border-bottom');
                    }
                    board.appendChild(cell);
                }
            }
        }
        
        function handleCellClick(e) {
            if (activeCell) {
                activeCell.classList.remove('active');
            }
            if (e.target.classList.contains('fixed')) {
                activeCell = null;
                return;
            }
            activeCell = e.target;
            activeCell.classList.add('active');
        }

        function handleNumberInput(e) {
            if (activeCell && !activeCell.classList.contains('fixed')) {
                const key = e.key;
                if (key >= '1' && key <= '9') {
                    activeCell.textContent = key;
                } else if (key === 'Backspace' || key === 'Delete') {
                    activeCell.textContent = '';
                }
            }
        }

        function checkSolution() {
            let isCorrect = true;
            const cells = board.querySelectorAll('.sudoku-cell');
            
            cells.forEach(cell => cell.classList.remove('error'));
            
            // Check against the solution
            for (let r = 0; r < PUZZLE_SIZE; r++) {
                for (let c = 0; c < PUZZLE_SIZE; c++) {
                    const cellIndex = r * PUZZLE_SIZE + c;
                    const cell = cells[cellIndex];
                    const value = cell.textContent ? parseInt(cell.textContent) : 0;
                    
                    if (value !== solution[r][c]) {
                        cell.classList.add('error');
                        isCorrect = false;
                    }
                }
            }
            
            if (isCorrect) {
                showMessage("Puzzle solved! You've earned 300 points!", "win");
                awardPointsForWin(300);
            } else {
                showMessage("There are errors on the board. Keep trying!", "error");
            }
        }
        
        function useHint() {
            if (hintsLeft > 0) {
                // Find all empty cells
                const emptyCells = Array.from(board.querySelectorAll('.sudoku-cell')).filter(cell => cell.textContent === '' && !cell.classList.contains('fixed'));
                
                if (emptyCells.length > 0) {
                    const randomIndex = Math.floor(Math.random() * emptyCells.length);
                    const cell = emptyCells[randomIndex];
                    const row = cell.dataset.row;
                    const col = cell.dataset.col;
                    
                    cell.textContent = solution[row][col];
                    cell.classList.add('fixed'); // Mark as fixed so it can't be changed

                    hintsLeft--;
                    hintsLeftSpan.textContent = hintsLeft;
                    
                    if (hintsLeft === 0) {
                        hintButton.disabled = true;
                    }
                } else {
                    showMessage("No empty cells left for a hint!", "error");
                }
            } else {
                showMessage("You are out of hints!", "error");
                hintButton.disabled = true;
            }
        }

        function showMessage(text, type) {
            messageArea.textContent = text;
            messageArea.style.color = type === "win" ? "green" : "red";
        }

        function startNewGame() {
            createPuzzle();
            renderBoard();
            showMessage("");
            hintsLeft = 3;
            hintsLeftSpan.textContent = hintsLeft;
            hintButton.disabled = false;
        }

        // --- Point System Integration with Dashboard ---
        async function updatePoints(amount) {
            if (!userId || !isAuthReady) {
                console.error("User not authenticated or authentication is not ready.");
                return;
            }
            const userRef = doc(db, `artifacts/${appId}/users/${userId}/data/user_points`);
            try {
                await setDoc(userRef, { points: increment(amount) }, { merge: true });
                console.log(`Points updated in Firestore: +${amount}`);
            } catch (error) {
                console.error("Error updating points:", error);
            }
        }

        function awardPointsForWin(points) {
            const pointsToAward = points;
            console.log(`Sending message to parent to award ${pointsToAward} points.`);
            window.parent.postMessage({ type: 'points_earned', value: pointsToAward }, '*');
        }

        // --- Event Listeners and Initial Call ---
        window.onload = () => {
             onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Sudoku game loaded for user:", userId);
                    startNewGame();
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // This should not happen in a Canvas environment
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error signing in:", error);
                    }
                }
            });
        };
        
        board.addEventListener('click', handleCellClick);
        document.addEventListener('keydown', handleNumberInput);
        checkButton.addEventListener('click', checkSolution);
        newGameButton.addEventListener('click', startNewGame);
        hintButton.addEventListener('click', useHint);
    </script>
</body>
</html>
