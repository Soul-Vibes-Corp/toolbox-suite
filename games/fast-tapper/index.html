<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tapper Game</title>
    <style>
        /* General page and container styling */
        body {
            background-color: #f6f8fa;
            color: #1c1c1c;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 600px;
            width: 100%;
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #005fa3;
            margin-bottom: 20px;
        }

        .stats-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }

        .stat-box {
            background-color: #e8f4ff;
            color: #005fa3;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        
        #game-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
            aspect-ratio: 1 / 1;
            max-width: 400px;
            border: 2px solid #a3e6ff;
            background-color: #d8e6f1;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .game-cell {
            background-color: #e8f4ff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

        .game-cell.target {
            background-color: #007bff;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
        }

        .game-cell:not(.target):hover {
            background-color: #c9d6e4;
        }

        .game-instructions {
            margin-top: 30px;
            padding: 20px;
            background-color: #e8f4ff;
            border: 1px solid #a3e6ff;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            width: 100%;
        }

        .game-instructions h2 {
            color: #005fa3;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .game-instructions p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .game-title { font-size: 2rem; }
            .stats-container { flex-direction: column; gap: 10px; }
            .stat-box { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">Fast Tapper</h1>
        <div class="stats-container">
            <div class="stat-box">Score: <span id="score-value">0</span></div>
            <div class="stat-box">Time: <span id="time-value">30</span>s</div>
        </div>
        <div id="game-grid">
            <!-- Game cells will be dynamically generated here -->
        </div>
        <div class="game-instructions">
            <h2>Fast Tapper: How to Play</h2>
            <p>Welcome to **Fast Tapper**, a speed and accuracy game where you can earn points for your account! The goal is to tap the changing targets as quickly as possible to earn points before the timer runs out.</p>
            
            <h3>How to Play</h3>
            <p><strong>1. Watch the Grid:</strong> The game grid has multiple cells. One cell will randomly become the target, highlighted with a blue background. </p>
            <p><strong>2. Tap the Target:</strong> Your goal is to click or tap the highlighted target cell as quickly as you can. When you hit the target, it will disappear and a new one will appear somewhere else.</p>
            <p><strong>3. Beat the Clock:</strong> You have 30 seconds to earn as many points as possible. The game ends when the timer runs out.</p>
            
            <h3>Earning Points</h3>
            <p>Each time you successfully tap a target, you earn **10 points**. Your total score at the end of the 30-second round will be automatically added to your account and reflected on your dashboard.</p>
        </div>
    </div>
    <script type="module">
        import { getAuth, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getFirestore, doc, setDoc, increment } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";

        // Firebase-specific Canvas variables for authentication
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase configuration from your dashboard
        const firebaseConfig = {
            apiKey: "AIzaSyA0tfVT75kWle3uwz1HouHRQdEWyzW1YNU",
            authDomain: "chat-code-forum.firebaseapp.com",
            projectId: "chat-code-forum",
            storageBucket: "chat-code-forum.appspot.com",
            messagingSenderId: "496765673859",
            appId: "1:496765673859:web:6c2e6695be447d6e32d6b6",
            measurementId: "G-XJKWXHF8WN"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let userId = null;
        let isAuthReady = false;

        // --- Game Logic ---
        const gameGrid = document.getElementById('game-grid');
        const scoreValueSpan = document.getElementById('score-value');
        const timeValueSpan = document.getElementById('time-value');
        
        let score = 0;
        let timeLeft = 30;
        let gameInterval = null;
        let currentTargetIndex = -1;
        const GRID_SIZE = 16;
        const CELLS_PER_ROW = 4;

        function createGrid() {
            gameGrid.innerHTML = '';
            for (let i = 0; i < GRID_SIZE; i++) {
                const cell = document.createElement('div');
                cell.classList.add('game-cell');
                cell.dataset.index = i;
                cell.addEventListener('click', handleTap);
                gameGrid.appendChild(cell);
            }
        }

        function handleTap(event) {
            if (!gameInterval) return; // Don't allow taps if game isn't running

            const tappedCell = event.target;
            if (tappedCell.classList.contains('target')) {
                score += 10;
                scoreValueSpan.textContent = score;
                tappedCell.classList.remove('target');
                setRandomTarget();
            }
        }

        function setRandomTarget() {
            // Remove the old target
            const oldTarget = gameGrid.querySelector('.target');
            if (oldTarget) {
                oldTarget.classList.remove('target');
            }
            
            // Set a new target
            let newTargetIndex = -1;
            do {
                newTargetIndex = Math.floor(Math.random() * GRID_SIZE);
            } while (newTargetIndex === currentTargetIndex);

            gameGrid.children[newTargetIndex].classList.add('target');
            currentTargetIndex = newTargetIndex;
        }

        function gameLoop() {
            timeLeft--;
            timeValueSpan.textContent = timeLeft;

            if (timeLeft <= 0) {
                endGame();
            }
        }

        function endGame() {
            clearInterval(gameInterval);
            gameInterval = null;
            alert(`Game Over! You scored ${score} points!`);
            awardPointsForWin(score);
            score = 0;
            scoreValueSpan.textContent = score;
        }
        
        function startGame() {
            score = 0;
            timeLeft = 30;
            scoreValueSpan.textContent = score;
            timeValueSpan.textContent = timeLeft;
            gameInterval = setInterval(gameLoop, 1000);
            setRandomTarget();
        }
        
        // --- Point System Integration with Dashboard ---
        async function updatePoints(amount) {
            if (!userId || !isAuthReady) {
                console.error("User not authenticated or authentication is not ready.");
                return;
            }
            const userRef = doc(db, `artifacts/${appId}/users/${userId}/data/user_points`);
            try {
                await setDoc(userRef, { points: increment(amount) }, { merge: true });
                console.log(`Points updated in Firestore: +${amount}`);
            } catch (error) {
                console.error("Error updating points:", error);
            }
        }
        
        function awardPointsForWin(points) {
            // This is the key line that links the game to the dashboard
            window.parent.postMessage({ type: 'points_earned', value: points }, '*');
        }

        // --- Event Listeners and Initial Call ---
        window.onload = () => {
             onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Fast Tapper game loaded for user:", userId);
                    createGrid();
                    // Start the game automatically on load
                    startGame();
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            console.error("No authentication token available. Cannot sign in.");
                        }
                    } catch (error) {
                        console.error("Error signing in:", error);
                    }
                }
            });
        };
    </script>
</body>
</html>
