<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Mahjong Match</title>
Â  Â  <style>
Â  Â  Â  Â  /* General page and container styling */
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  background-color: #f6f8fa;
Â  Â  Â  Â  Â  Â  color: #1c1c1c;
Â  Â  Â  Â  Â  Â  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  -webkit-font-smoothing: antialiased;
Â  Â  Â  Â  Â  Â  -moz-osx-font-smoothing: grayscale;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .game-container {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  .game-title {
Â  Â  Â  Â  Â  Â  font-size: 2.5rem;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: #005fa3;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .score-display {
Â  Â  Â  Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  Â  Â  Â  color: #346f99;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  canvas {
Â  Â  Â  Â  Â  Â  border: 2px solid #a3e6ff;
Â  Â  Â  Â  Â  Â  background-color: #e8f4ff;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  touch-action: none;
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }

Â  Â  Â  Â  .game-instructions {
Â  Â  Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  Â  Â  margin-top: 30px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  background-color: #e8f4ff;
Â  Â  Â  Â  Â  Â  border: 1px solid #a3e6ff;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .game-instructions h2 {
Â  Â  Â  Â  Â  Â  color: #005fa3;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .game-instructions p {
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  line-height: 1.6;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Responsive adjustments */
Â  Â  Â  Â  @media (max-width: 600px) {
Â  Â  Â  Â  Â  Â  .game-title {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 2rem;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .score-display {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <div class="game-container">
Â  Â  Â  Â  <h1 class="game-title">Mahjong Match</h1>
Â  Â  Â  Â  <div class="score-display">Score: <span id="score-value">0</span></div>
Â  Â  Â  Â  <canvas id="gameCanvas"></canvas>
Â  Â  Â  Â  <div class="game-instructions">
Â  Â  Â  Â  Â  Â  <h2>Mahjong Match: How to Play</h2>
Â  Â  Â  Â  Â  Â  <p>Welcome to **Mahjong Match**, a relaxing puzzle game where you can earn points for your account! The goal is simple: clear the board by matching all the pairs of identical tiles.</p>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <h3>How to Play</h3>
Â  Â  Â  Â  Â  Â  <p><strong>1. Select a Tile:</strong> Click or tap on any tile to select it. The tile will be highlighted to show it's active.</p>
Â  Â  Â  Â  Â  Â  <p><strong>2. Find a Match:</strong> Find and select a second tile with the exact same icon. If the two tiles match, they will be removed from the board and you'll earn points!</p>
Â  Â  Â  Â  Â  Â  <p><strong>3. Clear the Board:</strong> Continue matching pairs until you have cleared the entire board. Once all tiles are gone, you win the game!</p>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <h3>Earning Points</h3>
Â  Â  Â  Â  Â  Â  <p>Each time you successfully match a pair of tiles, you earn **100 points**. When you clear the entire board, you'll be awarded a bonus of **500 points**. These points are automatically added to your account and will be reflected on your dashboard.</p>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script type="module">
Â  Â  Â  Â  import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
Â  Â  Â  Â  import { getFirestore, doc, setDoc, getDoc, increment } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";

Â  Â  Â  Â  // Use canvas variables if they exist, otherwise use fallbacks
Â  Â  Â  Â  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
Â  Â  Â  Â  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
Â  Â  Â  Â  
Â  Â  Â  Â  // Firebase configuration from your dashboard
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyA0tfVT75kWle3uwz1HouHRQdEWyzW1YNU",
Â  Â  Â  Â  Â  Â  authDomain: "chat-code-forum.firebaseapp.com",
Â  Â  Â  Â  Â  Â  projectId: "chat-code-forum",
Â  Â  Â  Â  Â  Â  storageBucket: "chat-code-forum.appspot.com",
Â  Â  Â  Â  Â  Â  messagingSenderId: "496765673859",
Â  Â  Â  Â  Â  Â  appId: "1:496765673859:web:6c2e6695be447d6e32d6b6",
Â  Â  Â  Â  Â  Â  measurementId: "G-XJKWXHF8WN"
Â  Â  Â  Â  };
Â  Â  Â  Â  
Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  const auth = getAuth(app);
Â  Â  Â  Â  const db = getFirestore(app);
Â  Â  Â  Â  
Â  Â  Â  Â  let userId = null;

Â  Â  Â  Â  // --- Game Setup ---
Â  Â  Â  Â  const canvas = document.getElementById('gameCanvas');
Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  const scoreValueSpan = document.getElementById('score-value');
Â  Â  Â  Â  let score = 0;
Â  Â  Â  Â  let tiles = [];
Â  Â  Â  Â  let selectedTile = null;
Â  Â  Â  Â  let gameActive = false;

Â  Â  Â  Â  const tileRows = 8;
Â  Â  Â  Â  const tileCols = 8;
Â  Â  Â  Â  const tilePadding = 5;
Â  Â  Â  Â  let tileSize = 0;

Â  Â  Â  Â  const tileIcons = ['ğŸ¥‘', 'ğŸ', 'ğŸŒ', 'ğŸ’', 'ğŸ¥¥', 'ğŸ‡', 'ğŸ¥', 'ğŸ‹', 'ğŸ“', 'ğŸ‰', 'ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‘', 'ğŸŒ¶ï¸', 'ğŸ†'];
Â  Â  Â  Â  
Â  Â  Â  Â  // --- Game Logic ---
Â  Â  Â  Â  function createBoard() {
Â  Â  Â  Â  Â  Â  const numPairs = (tileRows * tileCols) / 2;
Â  Â  Â  Â  Â  Â  const shuffledIcons = shuffleArray(tileIcons).slice(0, numPairs);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let gameIcons = [...shuffledIcons, ...shuffledIcons];
Â  Â  Â  Â  Â  Â  gameIcons = shuffleArray(gameIcons);

Â  Â  Â  Â  Â  Â  tiles = [];
Â  Â  Â  Â  Â  Â  for (let r = 0; r < tileRows; r++) {
Â  Â  Â  Â  Â  Â  Â  Â  for (let c = 0; c < tileCols; c++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tiles.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon: gameIcons.pop(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row: r,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  col: c,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: c * (tileSize + tilePadding),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: r * (tileSize + tilePadding),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  matched: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  visible: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawBoard() {
Â  Â  Â  Â  Â  Â  ctx.clearRect(0, 0, canvas.width, canvas.height);
Â  Â  Â  Â  Â  Â  ctx.font = `${tileSize / 2}px Arial`;
Â  Â  Â  Â  Â  Â  ctx.textAlign = 'center';
Â  Â  Â  Â  Â  Â  ctx.textBaseline = 'middle';

Â  Â  Â  Â  Â  Â  tiles.forEach(tile => {
Â  Â  Â  Â  Â  Â  Â  Â  if (tile.visible) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Draw tile background
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = selectedTile && selectedTile.icon === tile.icon && selectedTile !== tile ? '#5ec9f0' : '#d3d6da';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (selectedTile && selectedTile.x === tile.x && selectedTile.y === tile.y) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#6aaa64'; // Highlight selected tile
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillRect(tile.x, tile.y, tileSize, tileSize);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Draw icon
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#1c1c1c';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText(tile.icon, tile.x + tileSize / 2, tile.y + tileSize / 2);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function handleCanvasClick(event) {
Â  Â  Â  Â  Â  Â  if (!gameActive) return;
Â  Â  Â  Â  Â  Â  const rect = canvas.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  const mouseX = event.clientX - rect.left;
Â  Â  Â  Â  Â  Â  const mouseY = event.clientY - rect.top;

Â  Â  Â  Â  Â  Â  const clickedTile = tiles.find(tile => 
Â  Â  Â  Â  Â  Â  Â  Â  tile.visible &&
Â  Â  Â  Â  Â  Â  Â  Â  mouseX >= tile.x &&
Â  Â  Â  Â  Â  Â  Â  Â  mouseX <= tile.x + tileSize &&
Â  Â  Â  Â  Â  Â  Â  Â  mouseY >= tile.y &&
Â  Â  Â  Â  Â  Â  Â  Â  mouseY <= tile.y + tileSize
Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  if (clickedTile) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!selectedTile) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // First tile selected
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedTile = clickedTile;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawBoard();
Â  Â  Â  Â  Â  Â  Â  Â  } else if (selectedTile.x === clickedTile.x && selectedTile.y === clickedTile.y) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Clicking the same tile deselects it
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedTile = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawBoard();
Â  Â  Â  Â  Â  Â  Â  Â  } else if (selectedTile.icon === clickedTile.icon) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // A successful match!
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  score += 100;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scoreValueSpan.textContent = score;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedTile.visible = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clickedTile.visible = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedTile = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawBoard();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  checkWin();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Mismatch, deselect the first tile
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedTile = clickedTile;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawBoard();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function checkWin() {
Â  Â  Â  Â  Â  Â  if (tiles.every(tile => !tile.visible)) {
Â  Â  Â  Â  Â  Â  Â  Â  gameActive = false;
Â  Â  Â  Â  Â  Â  Â  Â  alert(`You won! Final score: ${score}`);
Â  Â  Â  Â  Â  Â  Â  Â  awardPointsForWin(score);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function shuffleArray(array) {
Â  Â  Â  Â  Â  Â  for (let i = array.length - 1; i > 0; i--) {
Â  Â  Â  Â  Â  Â  Â  Â  const j = Math.floor(Math.random() * (i + 1));
Â  Â  Â  Â  Â  Â  Â  Â  [array[i], array[j]] = [array[j], array[i]];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return array;
Â  Â  Â  Â  }

Â  Â  Â  Â  function resizeCanvas() {
Â  Â  Â  Â  Â  Â  // Adjust canvas size to fit window while maintaining aspect ratio
Â  Â  Â  Â  Â  Â  const parentWidth = canvas.parentElement.offsetWidth;
Â  Â  Â  Â  Â  Â  const parentHeight = window.innerHeight * 0.6; // Take up 60% of viewport height
Â  Â  Â  Â  Â  Â  const size = Math.min(parentWidth, parentHeight);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  canvas.width = size;
Â  Â  Â  Â  Â  Â  canvas.height = size;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  tileSize = (size - (tileCols + 1) * tilePadding) / tileCols;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Re-draw the board after resizing
Â  Â  Â  Â  Â  Â  drawBoard();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Point System Integration with Dashboard ---
Â  Â  Â  Â  async function updatePoints(amount) {
Â  Â  Â  Â  Â  Â  if (!userId) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("User not authenticated.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const userRef = doc(db, `artifacts/${appId}/users/${userId}/data/user_points`);
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(userRef, { points: increment(amount) }, { merge: true });
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Points updated in Firestore: +${amount}`);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error updating points:", error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function awardPointsForWin(points) {
Â  Â  Â  Â  Â  Â  // You can adjust the points awarded here
Â  Â  Â  Â  Â  Â  const pointsToAward = points + 500; // Bonus for winning the game
Â  Â  Â  Â  Â  Â  console.log(`Sending message to parent to award ${pointsToAward} points.`);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // This is the key line that links the game to the dashboard
Â  Â  Â  Â  Â  Â  window.parent.postMessage({ type: 'points_earned', value: pointsToAward }, '*');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Main Game Loop ---
Â  Â  Â  Â  function initGame() {
Â  Â  Â  Â  Â  Â  score = 0;
Â  Â  Â  Â  Â  Â  scoreValueSpan.textContent = score;
Â  Â  Â  Â  Â  Â  selectedTile = null;
Â  Â  Â  Â  Â  Â  gameActive = true;
Â  Â  Â  Â  Â  Â  resizeCanvas();
Â  Â  Â  Â  Â  Â  createBoard();
Â  Â  Â  Â  Â  Â  drawBoard();
Â  Â  Â  Â  }

Â  Â  Â  Â  window.addEventListener('resize', resizeCanvas);
Â  Â  Â  Â  canvas.addEventListener('click', handleCanvasClick);
Â  Â  Â  Â  
Â  Â  Â  window.onload = () => {
Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  userId = user.uid;
Â  Â  Â  Â  Â  Â  console.log("Mahjong game loaded for user:", userId);
Â  Â  Â  Â  Â  Â  // Now that we have a user, we can safely initialize the game
Â  Â  Â  Â  Â  Â  initGame();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  if (initialAuthToken) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInWithCustomToken(auth, initialAuthToken);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("No authentication token available. Cannot sign in.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error signing in:", error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });
};
Â  Â  </script>
</body>
</html>
